#renaming the samples according to metadata information (use ln -s instead of mv for links)
mv 25964_ATTACTCGGGCTCTGA_C6VNAANXX_6_20150508B_20150508.bam GcnE-FLAG_noSrapa_Siran-mutant_FLAGM2_Rep1_25964_ATTACTCGGGCTCTGA_C6VNAANXX_6_20150508B_20150508.bam
mv 25966_ATTACTCGTAATCTTA_C6VNAANXX_6_20150508B_20150508.bam GcnE-FLAG_Srapa_noSiran_FLAGM2_Rep2_25966_ATTACTCGTAATCTTA_C6VNAANXX_6_20150508B_20150508.bam
mv 25967_ATTACTCGCAGGACGT_C6VNAANXX_6_20150508B_20150508.bam GcnE-FLAG_noSrapa_Siran_FLAGM2_Rep2_25967_ATTACTCGCAGGACGT_C6VNAANXX_6_20150508B_20150508.bam
mv 25968_ATTACTCGGTACTGAC_C6VNAANXX_6_20150508B_20150508.bam GcnE-FLAG_noSrapa_Siran-mutant_FLAGM2_Rep2_25968_ATTACTCGGTACTGAC_C6VNAANXX_6_20150508B_20150508.bam
mv 25969_TCCGGAGATATAGCCT_C6VNAANXX_6_20150508B_20150508.bam GcnE-FLAG_noSrapa_noSiran_H3K9ac_Rep1_25969_TCCGGAGATATAGCCT_C6VNAANXX_6_20150508B_20150508.bam
mv 25970_TCCGGAGAATAGAGGC_C6VNAANXX_6_20150508B_20150508.bam GcnE-FLAG_Srapa_noSiran_H3K9ac_Rep1_25970_TCCGGAGAATAGAGGC_C6VNAANXX_6_20150508B_20150508.bam
mv 25971_TCCGGAGACCTATCCT_C6VNAANXX_6_20150508B_20150508.bam GcnE-FLAG_noSrapa_Siran_H3K9ac_Rep1_25971_TCCGGAGACCTATCCT_C6VNAANXX_6_20150508B_20150508.bam
mv 25972_TCCGGAGAGGCTCTGA_C6VNAANXX_6_20150508B_20150508.bam GcnE-FLAG_noSrapa_Siran-mutant_H3K9ac_Rep1_25972_TCCGGAGAGGCTCTGA_C6VNAANXX_6_20150508B_20150508.bam
mv 25973_TCCGGAGAAGGCGAAG_C6VNAANXX_6_20150508B_20150508.bam GcnE-FLAG_noSrapa_noSiran_H3K9ac_Rep2_25973_TCCGGAGAAGGCGAAG_C6VNAANXX_6_20150508B_20150508.bam
mv 25974_TCCGGAGATAATCTTA_C6VNAANXX_6_20150508B_20150508.bam GcnE-FLAG_Srapa_noSiran_H3K9ac_Rep2_25974_TCCGGAGATAATCTTA_C6VNAANXX_6_20150508B_20150508.bam
mv 25975_TCCGGAGACAGGACGT_C6VNAANXX_6_20150508B_20150508.bam GcnE-FLAG_noSrapa_Siran_H3K9ac_Rep2_25975_TCCGGAGACAGGACGT_C6VNAANXX_6_20150508B_20150508.bam
mv 25976_TCCGGAGAGTACTGAC_C6VNAANXX_6_20150508B_20150508.bam GcnE-FLAG_noSrapa_Siran-mutant_H3K9ac_Rep2_25976_TCCGGAGAGTACTGAC_C6VNAANXX_6_20150508B_20150508.bam
mv 25977_CGCTCATTTATAGCCT_C6VNAANXX_6_20150508B_20150508.bam GcnE-FLAG_noSrapa_noSiran_H3K14ac_Rep1_25977_CGCTCATTTATAGCCT_C6VNAANXX_6_20150508B_20150508.bam
mv 25978_CGCTCATTATAGAGGC_C6VNAANXX_6_20150508B_20150508.bam GcnE-FLAG_Srapa_noSiran_H3K14ac_Rep1_25978_CGCTCATTATAGAGGC_C6VNAANXX_6_20150508B_20150508.bam
mv 25979_CGCTCATTCCTATCCT_C6VNAANXX_6_20150508B_20150508.bam GcnE-FLAG_noSrapa_Siran_H3K14ac_Rep1_25979_CGCTCATTCCTATCCT_C6VNAANXX_6_20150508B_20150508.bam
mv 25980_CGCTCATTGGCTCTGA_C6VNAANXX_6_20150508B_20150508.bam GcnE-FLAG_noSrapa_Siran-mutant_H3K14ac_Rep1_25980_CGCTCATTGGCTCTGA_C6VNAANXX_6_20150508B_20150508.bam
mv 25981_CGCTCATTAGGCGAAG_C6VNAANXX_6_20150508B_20150508.bam GcnE-FLAG_noSrapa_noSiran_H3K14ac_Rep2_25981_CGCTCATTAGGCGAAG_C6VNAANXX_6_20150508B_20150508.bam
mv 25982_CGCTCATTTAATCTTA_C6VNAANXX_6_20150508B_20150508.bam GcnE-FLAG_Srapa_noSiran_H3K14ac_Rep2_25982_CGCTCATTTAATCTTA_C6VNAANXX_6_20150508B_20150508.bam
mv 25983_CGCTCATTCAGGACGT_C6VNAANXX_6_20150508B_20150508.bam GcnE-FLAG_noSrapa_Siran_H3K14ac_Rep2_25983_CGCTCATTCAGGACGT_C6VNAANXX_6_20150508B_20150508.bam
mv 25984_CGCTCATTGTACTGAC_C6VNAANXX_6_20150508B_20150508.bam GcnE-FLAG_noSrapa_Siran-mutant_H3K14ac_Rep2_25984_CGCTCATTGTACTGAC_C6VNAANXX_6_20150508B_20150508.bam
mv 25985_GAGATTCCTATAGCCT_C6VNAANXX_6_20150508B_20150508.bam GcnE-FLAG_noSrapa_noSiran_H3Cterm_Rep1_25985_GAGATTCCTATAGCCT_C6VNAANXX_6_20150508B_20150508.bam
mv 25986_GAGATTCCATAGAGGC_C6VNAANXX_6_20150508B_20150508.bam GcnE-FLAG_Srapa_noSiran_H3Cterm_Rep1_25986_GAGATTCCATAGAGGC_C6VNAANXX_6_20150508B_20150508.bam
mv 25987_GAGATTCCCCTATCCT_C6VNAANXX_6_20150508B_20150508.bam GcnE-FLAG_noSrapa_Siran_H3Cterm_Rep1_25987_GAGATTCCCCTATCCT_C6VNAANXX_6_20150508B_20150508.bam
mv 25988_GAGATTCCGGCTCTGA_C6VNAANXX_6_20150508B_20150508.bam GcnE-FLAG_noSrapa_Siran-mutant_H3Cterm_Rep1_25988_GAGATTCCGGCTCTGA_C6VNAANXX_6_20150508B_20150508.bam
mv 25989_GAGATTCCAGGCGAAG_C6VNAANXX_6_20150508B_20150508.bam GcnE-FLAG_noSrapa_noSiran_H3Cterm_Rep2_25989_GAGATTCCAGGCGAAG_C6VNAANXX_6_20150508B_20150508.bam
mv 25990_GAGATTCCTAATCTTA_C6VNAANXX_6_20150508B_20150508.bam GcnE-FLAG_Srapa_noSiran_H3Cterm_Rep2_25990_GAGATTCCTAATCTTA_C6VNAANXX_6_20150508B_20150508.bam
mv 25991_GAGATTCCCAGGACGT_C6VNAANXX_6_20150508B_20150508.bam GcnE-FLAG_noSrapa_Siran_H3Cterm_Rep2_25991_GAGATTCCCAGGACGT_C6VNAANXX_6_20150508B_20150508.bam
mv 25992_GAGATTCCGTACTGAC_C6VNAANXX_6_20150508B_20150508.bam GcnE-FLAG_noSrapa_Siran-mutant_H3Cterm_Rep2_25992_GAGATTCCGTACTGAC_C6VNAANXX_6_20150508B_20150508.bam
mv 25997_ATTCAGAAAGGCGAAG_C6VNAANXX_6_20150508B_20150508.bam WT_Srapa_noSiran_FLAGM2_Rep1_25997_ATTCAGAAAGGCGAAG_C6VNAANXX_6_20150508B_20150508.bam

#this is only the list from the lane2 samples! others were renamed manually (no record).

PATH=/applications/bowtie2/bowtie2-2.2.4/:$PATH

#27.7.2015
wget http://www.aspgd.org/download/gff/A_nidulans_FGSC_A4/A_nidulans_FGSC_A4_version_s10-m03-r28_features.gff

wget http://www.aspgd.org/download/gff/A_nidulans_FGSC_A4/A_nidulans_FGSC_A4_version_s10-m03-r28_intergenic.gff

wget http://www.aspgd.org/download/sequence/A_nidulans_FGSC_A4/current/A_nidulans_FGSC_A4_version_s10-m03-r28_chromosomes.fasta.gz

# creating a concatenated genome (3 species)!!:
cat A_nidulans_FGSC_A4_version_s10-m03-r28_chromosomes.fasta Streptomyces_iranensis_genome_assembly_Siranensis_SCAF00001.fa Streptomyces_rapamycinicus_NRRL_5491_genome.fa > Anidulans_Siranensis_Srapamucinicus_merged_genomes.fa

#bowtie2 index
/applications/bowtie2/bowtie2-2.2.4/bowtie2-build Anidulans_Siranensis_Srapamucinicus_merged_genomes.fa Anidulans_Siranensis_Srapamucinicus_merged_genomes

##fq seems phred+33 since N == ! -> using default in trimgalore!

file=26011_ATTCAGAAAGGCGAAG_C6VNAANXX_7_201505080_20150508.bam
bedtools bamtofastq -i $file -fq ${file%.bam}.fq

file=GcnE-FLAG_K3K9ac_25969_C6VNAANXX_6_20150508B_20150511.fq
/scripts/csmit -w 20 -m 20G -c 40 "bowtie2 -q -x $index -U ${file%.fq}.fq -S ${file%.fq}.sam -p 40 >> $file.bowtie2log 2>&1"

index=Anidulans_Siranensis_Srapamucinicus_merged_genomes
file=GcnE-FLAG_M2_siranensisC6VNAANXX_6_20150508B_20150511_trimmed.fq
bowtie2 -q -x $index -U $file -S ${file%.fq}.sam -p 1 >> $file.bowtie2log 2>&1

##
file=GcnE-FLAG_M2_siranensisC6VNAANXX_6_20150508B_20150511.fasta
tail -n 10000 $file > tmp
/applications/ncbi-blast+/ncbi-blast-2.2.30+/bin/blastn -num_threads 20 -evalue 0.01 -outfmt '7 std scomnam sacc staxids qacc sallseqid sallgi sscinames scomnames sblastnames sskingdoms salltitles' -num_alignments 5 -db /data/public_data/NCBI/NCBI_nt/nt -query tmp -out ${file%}.first_10000.blast
	less ${file%}.first_10000.blast | sort -u -k1,1 --merge > tmp; mv tmp ${file%}.first_10000.blast
	rm ${file%.bam}.unmapped.fasta
	
##stats

logfile=mapping_efficency_bowtie2.txt
for file in $(ls *.bowtie2log); do
echo $file >> $logfile
cat $file >> $logfile
done

##conclusion: samples were not de-multiplexed!

##lane2
index=/home/sm934/analysis/jule_chipseq/Anidulans_Siranensis_Srapamucinicus_merged_genomes
for file in $(ls *.bam); do
bedtools bamtofastq -i $file -fq ${file%.bam}.fq
/scripts/csmit -b -w 24 -m 20G -c 20 "bowtie2 -q -x $index -U ${file%.bam}.fq -S ${file%.bam}_mapped.sam -p 20 >> $file.bowtie2log 2>&1"
sleep 30
done
chrsizes=/home/sm934/analysis/jule_chipseq/Anidulans_Siranensis_Srapamucinicus_merged_genomes.chrsizes
for file in $(ls *.sam); do
/scripts/csmit -b -m 20G -c 1 "~/bin/sam2bw.sh $file $chrsizes"
sleep 30
done

##creating normalized coverage tracks libsize=reads mapping on nidulans/1e6
for file in $(ls *mapped.bam); do
librarySize=$(samtools idxstats $file | grep "nidulans" |awk '{total+=$3}END {print total}')
/scripts/csmit -b -m 20G -c 1 "~/bin/bam2bwnorm.sh $file $chrsizes $librarySize"
sleep 5
done

# for file in $(ls *mapped.bam); do
# 	~/bin/bam2bw.sh $file ../Anidulans_Siranensis_Srapamucinicus_merged_genomes.chrsizes &
# done

##separating strans: easy for SE reads
#Flags 4 unmapped, 0=plus, 16=minus
file=GcnE-FLAG_Srapa_noSiran_K3K9ac_Rep3_26004_GCCAAT_C7U12ANXX_1_20150703B_20150703_mapped.bam
samtools view -b -F 16 -F 4  $file > ${file%.bam}_plus.bam &#plus
samtools view -b -f 16  $file > ${file%.bam}_minus.bam &#minus
~/bin/bam2bw.sh ${file%.bam}_minus.bam $chrsizes &
~/bin/bam2bw.sh ${file%.bam}_plus.bam $chrsizes &

librarySize=$(samtools idxstats ${file%.bam}_minus.bam | grep "nidulans" |awk '{total+=$3}END {print total}')
 bamToBed -i ${file%.bam}_minus.bam | sort -k1,1 -k2,2n | genomeCoverageBed -i stdin -g $chrsizes -d | awk -vOFS='\t' -vSIZE=$librarySize '{print $1,$2,$2 + 1,$3*1000000/SIZE}' | gzip > $ ${file}.density.gz 
 
librarySize=$(samtools idxstats $file | grep "nidulans" |awk '{total+=$3}END {print total}')
 bamToBed -i $file | sort -k1,1 -k2,2n | genomeCoverageBed -i stdin -g $chrsizes -d | awk -vOFS='\t' -vSIZE=$librarySize '{print $1,$2,$2 + 1,$3}' > ${file}.density.notnorm
 
librarySize=$(samtools idxstats $file | grep "nidulans" |awk '{total+=$3}END {print total}')
 ~/bin/bam2bwnorm.sh $file $chrsizes $librarySize

##creating stat table 
file2=GcnE-FLAG_noSrapa_noSiran_H3K9ac_Rep3_26003_ACAGTG_C7U12ANXX_1_20150703B_20150703_mapped.bam

for file2 in $(ls *mapped.bam);do
echo $file2 | sed -r 's/_[0-9]{5}_.*//g' >> ${file2}.idxstat; samtools idxstats $file2 | cut -f3 >> ${file2}.idxstat; echo -e "\n" >> ${file2}.idxstat
done
echo "Library" >> aa.idxstat; samtools idxstats $file2 | cut -f1 >> aa.idxstat
paste *.idxstat > Bowtie2_mapping_rates_chipseq_anidulans.csv



##RNA-Seq from Strauss
http://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSM1555044
wget ftp://ftp-trace.ncbi.nlm.nih.gov/sra/sra-instant/reads/ByExp/sra/SRX%2FSRX769%2FSRX769257/SRR1664214/SRR1664214.sra
 
